<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SAM.Manager.Views.AchievementManagerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SAM.Manager.Views"
    xmlns:models="using:SAM.Core.Models"
    xmlns:controls="using:SAM.Manager.Controls"
    NavigationCacheMode="Disabled">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Game Header with Cover Image -->
        <Grid Height="140" Margin="-24,-24,-24,0">
            <!-- Background Cover Image -->
                 <Image Source="{x:Bind ViewModel.HeaderImageUrl, Mode=OneWay}"
                   Stretch="UniformToFill"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"/>
            
            <!-- Gradient Overlay for readability -->
            <Rectangle>
                <Rectangle.Fill>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#80000000" Offset="0"/>
                        <GradientStop Color="#CC000000" Offset="0.7"/>
                        <GradientStop Color="#FF000000" Offset="1"/>
                    </LinearGradientBrush>
                </Rectangle.Fill>
            </Rectangle>
            
            <StackPanel VerticalAlignment="Bottom" Padding="24,0,24,16">
                <TextBlock Text="{x:Bind ViewModel.GameName, Mode=OneWay}" 
                           Style="{StaticResource TitleLargeTextBlockStyle}"
                           Foreground="White"/>
                <StackPanel Orientation="Horizontal" Spacing="16" Margin="0,8,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="2">
                        <TextBlock Text="{x:Bind ViewModel.UnlockedCount, Mode=OneWay}" Style="{StaticResource BodyTextBlockStyle}" Foreground="White"/>
                        <TextBlock Text="/" Style="{StaticResource BodyTextBlockStyle}" Foreground="White"/>
                        <TextBlock Text="{x:Bind ViewModel.Achievements.Count, Mode=OneWay}" Style="{StaticResource BodyTextBlockStyle}" Foreground="White"/>
                        <TextBlock Text=" Achievements" Style="{StaticResource BodyTextBlockStyle}" Foreground="White"/>
                    </StackPanel>
                    <ProgressBar Value="{x:Bind ViewModel.CompletionPercentage, Mode=OneWay}"
                                 Maximum="100"
                                 Width="200"/>
                    <StackPanel Orientation="Horizontal" Spacing="0">
                        <TextBlock Text="{x:Bind ViewModel.CompletionPercentage, Mode=OneWay}" Style="{StaticResource BodyTextBlockStyle}" Foreground="White"/>
                        <TextBlock Text="%" Style="{StaticResource BodyTextBlockStyle}" Foreground="White"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- DRM Protection Warning -->
        <InfoBar Grid.Row="1"
             IsOpen="{x:Bind ViewModel.HasProtectedAchievements, Mode=OneWay}"
                 Severity="Warning"
                 Title="Geschützte Erfolge"
             Message="{x:Bind ViewModel.ProtectedWarningMessage, Mode=OneWay}"
                 IsClosable="False"
                 Margin="0,8,0,0"/>

        <!-- Command Bar -->
        <CommandBar Grid.Row="2" 
                    DefaultLabelPosition="Right"
                    Background="Transparent"
                    Margin="0,8,0,0">
            <AppBarButton Icon="Refresh" 
                          Label="Aktualisieren"
                          Command="{x:Bind ViewModel.RefreshCommand}"/>
            <AppBarButton Icon="Save" 
                          Label="Speichern"
                          Command="{x:Bind ViewModel.StoreStatsCommand}"
                          IsEnabled="{x:Bind ViewModel.CanModifyAchievements, Mode=OneWay}">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Modifiers="Control" Key="S"/>
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>
            <AppBarSeparator/>
            <AppBarButton Icon="SelectAll" 
                          Label="Alle freischalten"
                          Command="{x:Bind ViewModel.UnlockAllCommand}"
                          IsEnabled="{x:Bind ViewModel.CanModifyAchievements, Mode=OneWay}"/>
            <AppBarButton Label="Alle sperren"
                          Command="{x:Bind ViewModel.LockAllCommand}"
                          IsEnabled="{x:Bind ViewModel.CanModifyAchievements, Mode=OneWay}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE711;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarButton Label="Invertieren"
                          Command="{x:Bind ViewModel.InvertAllCommand}"
                          IsEnabled="{x:Bind ViewModel.CanModifyAchievements, Mode=OneWay}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8AB;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarSeparator/>
            <AppBarButton Tag="StatisticsButton"
                          Label="Statistiken">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE9D9;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <CommandBar.SecondaryCommands>
                <AppBarButton Icon="Delete" 
                              Label="Alle Stats zurücksetzen"
                              Command="{x:Bind ViewModel.ResetAllCommand}"
                              IsEnabled="{x:Bind ViewModel.CanModifyAchievements, Mode=OneWay}"/>
            </CommandBar.SecondaryCommands>
        </CommandBar>

        <!-- Search and Filter -->
        <Grid Grid.Row="3" Margin="0,8,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MaxWidth="400"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

                <AutoSuggestBox
                            Tag="SearchBox"
                            PlaceholderText="Achievement suchen..."
                            QueryIcon="Find"/>

                <ComboBox
                      Tag="FilterComboBox"
                      Grid.Column="1"
                      Margin="16,0,0,0"
                      Width="150"
                      SelectedIndex="0">
                <ComboBoxItem Content="Alle"/>
                <ComboBoxItem Content="Freigeschaltet"/>
                <ComboBoxItem Content="Gesperrt"/>
                <ComboBoxItem Content="Geändert"/>
            </ComboBox>
        </Grid>

                <!-- Achievements List -->
                    <ListView Grid.Row="4"
                                ItemsSource="{x:Bind ViewModel.FilteredAchievements, Mode=OneWay}"
                                SelectionMode="None">
            <ListView.ItemContainerTransitions>
                <TransitionCollection>
                    <AddDeleteThemeTransition/>
                    <ReorderThemeTransition/>
                </TransitionCollection>
            </ListView.ItemContainerTransitions>
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:AchievementModel">
                    <Border x:Name="AchievementCard"
                            Padding="8" 
                            Margin="0,4"
                            CornerRadius="8"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            RenderTransformOrigin="0.5,0.5">
                        <Border.RenderTransform>
                            <ScaleTransform x:Name="CardScale" ScaleX="1" ScaleY="1"/>
                        </Border.RenderTransform>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="64"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Flash overlay for unlock/lock animation -->
                            <Border x:Name="FlashOverlay"
                                    Grid.ColumnSpan="4"
                                    CornerRadius="8"
                                    Opacity="0"
                                    Margin="-8"
                                    IsHitTestVisible="False"/>

                            <!-- Unlock Checkbox -->
                            <CheckBox IsChecked="{x:Bind IsUnlocked, Mode=TwoWay}"
                                      IsEnabled="{x:Bind IsProtected, Converter={StaticResource BoolNegationConverter}, Mode=OneWay}"
                                      VerticalAlignment="Center"
                                      Margin="8,0"/>

                            <!-- Achievement Icon -->
                            <Border Grid.Column="1" 
                                    Width="48" Height="48" 
                                    CornerRadius="4">
                                <Grid>
                                    <Grid x:Name="AchievementIconPlaceholder"
                                          Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                                        <FontIcon Glyph="&#xE7C3;"
                                                  FontSize="16"
                                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                                    </Grid>
                                    <Image x:Name="AchievementIconImage"
                                           Stretch="UniformToFill"
                                           Opacity="0"/>
                                </Grid>
                            </Border>

                            <!-- Achievement Info -->
                            <StackPanel Grid.Column="2" Margin="16,0" VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="{x:Bind Name, Mode=OneWay}" 
                                               Style="{StaticResource BodyStrongTextBlockStyle}"/>
                                    <FontIcon Glyph="&#xE72E;" 
                                              FontSize="12"
                                              Foreground="{ThemeResource SystemFillColorCautionBrush}"
                                              Visibility="{x:Bind IsModified, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                              ToolTipService.ToolTip="Geändert"/>
                                    <FontIcon Glyph="&#xE72E;" 
                                              FontSize="12"
                                              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                              Visibility="{x:Bind IsProtected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                              ToolTipService.ToolTip="Geschützt"/>
                                </StackPanel>
                                <TextBlock Text="{x:Bind Description, Mode=OneWay}" 
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           TextWrapping="Wrap"
                                           MaxLines="2"/>
                            </StackPanel>

                            <!-- Unlock Time -->
                            <StackPanel Grid.Column="3" 
                                        Orientation="Horizontal"
                                        Spacing="4"
                                        VerticalAlignment="Center"
                                        Visibility="{x:Bind IsUnlocked, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="Freigeschaltet:"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                <TextBlock Text="{x:Bind UnlockTime, Mode=OneWay}"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- Status Bar -->
        <Grid Grid.Row="5" 
              Padding="16,8"
              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                <TextBlock Text="{x:Bind ViewModel.FilteredTotalCount, Mode=OneWay}"
                           Style="{StaticResource CaptionTextBlockStyle}"/>
                <TextBlock Text="Achievements angezeigt"
                           Style="{StaticResource CaptionTextBlockStyle}"/>
            </StackPanel>

                <StackPanel Grid.Column="1" 
                    Orientation="Horizontal"
                    Spacing="8"
                    VerticalAlignment="Center"
                    Visibility="{x:Bind ViewModel.IsPagingEnabled, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <Button Content="&#xE72B;"
                    FontFamily="Segoe Fluent Icons"
                    Width="32" Height="28"
                    Command="{x:Bind ViewModel.PreviousPageCommand}"
                    IsEnabled="{x:Bind ViewModel.CanGoPrevious, Mode=OneWay}"/>
                <TextBlock Text="{x:Bind ViewModel.PageDisplay, Mode=OneWay}"
                       VerticalAlignment="Center"
                       Style="{StaticResource CaptionTextBlockStyle}"/>
                <Button Content="&#xE72A;"
                    FontFamily="Segoe Fluent Icons"
                    Width="32" Height="28"
                    Command="{x:Bind ViewModel.NextPageCommand}"
                    IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}"/>
                </StackPanel>

                <StackPanel Grid.Column="2" 
                        Orientation="Horizontal" 
                        Spacing="8"
                     Visibility="{x:Bind ViewModel.HasUnsavedChanges, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <FontIcon Glyph="&#xE7BA;" FontSize="12" 
                          Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                <TextBlock Text="Ungespeicherte Änderungen" 
                           Style="{StaticResource CaptionTextBlockStyle}"
                           Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
            </StackPanel>
        </Grid>

        <!-- Loading Overlay -->
          <Grid Tag="LoadingOverlay"
              Grid.RowSpan="6"
              Visibility="Collapsed"
              Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center"
                        Spacing="16">
                <ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock Text="Achievements werden geladen..." 
                           Style="{StaticResource BodyTextBlockStyle}"/>
            </StackPanel>
        </Grid>

        <!-- Error Info Bar -->
        <InfoBar Tag="ErrorInfoBar"
                 Grid.Row="4"
                 VerticalAlignment="Top"
                 IsOpen="False"
                 Severity="Error"
                 Title="Fehler"/>
        
        <!-- NotificationBar is created in code-behind to avoid WinRT Connect cast issues -->
    </Grid>
</Page>
