<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SAM.Manager.Views.AchievementManagerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SAM.Manager.Views"
    xmlns:models="using:SAM.Core.Models"
    xmlns:controls="using:SAM.Manager.Controls"
    NavigationCacheMode="Disabled">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Game Header with Cover Image -->
        <Grid Height="140" Margin="-24,-24,-24,0">
            <!-- Background Cover Image -->
            <Image Source="{x:Bind ViewModel.HeaderImageUrl, Mode=OneWay}"
                   Stretch="UniformToFill"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"/>
            
            <!-- Gradient Overlay for readability -->
            <Rectangle>
                <Rectangle.Fill>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#80000000" Offset="0"/>
                        <GradientStop Color="#CC000000" Offset="0.7"/>
                        <GradientStop Color="#FF000000" Offset="1"/>
                    </LinearGradientBrush>
                </Rectangle.Fill>
            </Rectangle>
            
            <StackPanel VerticalAlignment="Bottom" Padding="24,0,24,16">
                <TextBlock x:Name="GameNameText"
                           Text="{x:Bind ViewModel.GameName, Mode=OneWay}" 
                           Style="{StaticResource TitleLargeTextBlockStyle}"
                           Foreground="White"/>
                <StackPanel Orientation="Horizontal" Spacing="16" Margin="0,8,0,0">
                    <TextBlock Style="{StaticResource BodyTextBlockStyle}" Foreground="White">
                        <Run Text="{x:Bind ViewModel.UnlockedCount, Mode=OneWay}"/>
                        <Run Text="/"/>
                        <Run Text="{x:Bind ViewModel.Achievements.Count, Mode=OneWay}"/>
                        <Run Text="Achievements"/>
                    </TextBlock>
                    <ProgressBar Value="{x:Bind ViewModel.CompletionPercentage, Mode=OneWay}"
                                 Maximum="100"
                                 Width="200"/>
                    <TextBlock Style="{StaticResource BodyTextBlockStyle}" Foreground="White">
                        <Run Text="{x:Bind ViewModel.CompletionPercentage, Mode=OneWay}"/>
                        <Run Text="%"/>
                    </TextBlock>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- DRM Protection Warning -->
        <InfoBar Grid.Row="1"
                 IsOpen="{x:Bind ViewModel.HasProtectedAchievements, Mode=OneWay}"
                 Severity="Warning"
                 Title="Geschützte Erfolge"
                 Message="{x:Bind ViewModel.ProtectedWarningMessage, Mode=OneWay}"
                 IsClosable="False"
                 Margin="0,8,0,0"/>

        <!-- Command Bar -->
        <CommandBar Grid.Row="2" 
                    DefaultLabelPosition="Right"
                    Background="Transparent"
                    Margin="0,8,0,0">
            <AppBarButton x:Name="RefreshButton"
                          Icon="Refresh" 
                          Label="Aktualisieren"/>
            <AppBarButton x:Name="SaveButton"
                          Icon="Save" 
                          Label="Speichern">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Modifiers="Control" Key="S"/>
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>
            <AppBarSeparator/>
            <AppBarButton x:Name="UnlockAllButton"
                          Icon="SelectAll" 
                          Label="Alle freischalten"/>
            <AppBarButton x:Name="LockAllButton"
                          Label="Alle sperren">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE711;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarButton x:Name="InvertAllButton"
                          Label="Invertieren">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8AB;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarSeparator/>
            <AppBarButton x:Name="StatisticsButton"
                          Label="Statistiken">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE9D9;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <CommandBar.SecondaryCommands>
                <AppBarButton x:Name="ResetAllButton"
                              Icon="Delete" 
                              Label="Alle Stats zurücksetzen"/>
            </CommandBar.SecondaryCommands>
        </CommandBar>

        <!-- Search and Filter -->
        <Grid Grid.Row="3" Margin="0,8,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MaxWidth="400"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <AutoSuggestBox x:Name="SearchBox"
                            PlaceholderText="Achievement suchen..."
                            QueryIcon="Find"
                            TextChanged="SearchBox_TextChanged"/>

            <ComboBox x:Name="FilterComboBox"
                      Grid.Column="1"
                      Margin="16,0,0,0"
                      Width="150"
                      SelectedIndex="0"
                      SelectionChanged="FilterComboBox_SelectionChanged">
                <ComboBoxItem Content="Alle"/>
                <ComboBoxItem Content="Freigeschaltet"/>
                <ComboBoxItem Content="Gesperrt"/>
                <ComboBoxItem Content="Geändert"/>
            </ComboBox>
        </Grid>

        <!-- Achievements List -->
        <ListView x:Name="AchievementsListView"
              Grid.Row="4"
              ItemsSource="{x:Bind ViewModel.FilteredAchievements, Mode=OneWay}"
              SelectionMode="None"
              ContainerContentChanging="AchievementsListView_ContainerContentChanging">
            <ListView.ItemContainerTransitions>
                <TransitionCollection>
                    <AddDeleteThemeTransition/>
                    <ReorderThemeTransition/>
                </TransitionCollection>
            </ListView.ItemContainerTransitions>
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:AchievementModel">
                    <Border x:Name="AchievementCard"
                            Padding="8" 
                            Margin="0,4"
                            CornerRadius="8"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            RenderTransformOrigin="0.5,0.5">
                        <Border.RenderTransform>
                            <ScaleTransform x:Name="CardScale" ScaleX="1" ScaleY="1"/>
                        </Border.RenderTransform>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="64"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Flash overlay for unlock/lock animation -->
                            <Border x:Name="FlashOverlay"
                                    Grid.ColumnSpan="4"
                                    CornerRadius="8"
                                    Opacity="0"
                                    Margin="-8"
                                    IsHitTestVisible="False"/>

                            <!-- Unlock Checkbox -->
                            <CheckBox IsChecked="{x:Bind IsUnlocked, Mode=TwoWay}"
                                      IsEnabled="{x:Bind IsProtected, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}"
                                      VerticalAlignment="Center"
                                      Margin="8,0"/>

                            <!-- Achievement Icon -->
                            <Border Grid.Column="1" 
                                    Width="48" Height="48" 
                                    CornerRadius="4">
                                <Grid>
                                    <Grid x:Name="AchievementIconPlaceholder"
                                          Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                                        <FontIcon Glyph="&#xE7C3;"
                                                  FontSize="16"
                                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                                    </Grid>
                                    <Image x:Name="AchievementIconImage"
                                           Stretch="UniformToFill"
                                           Opacity="0"
                                           ImageOpened="AchievementIcon_ImageOpened"/>
                                </Grid>
                            </Border>

                            <!-- Achievement Info -->
                            <StackPanel Grid.Column="2" Margin="16,0" VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="{x:Bind Name, Mode=OneWay}" 
                                               Style="{StaticResource BodyStrongTextBlockStyle}"/>
                                    <FontIcon Glyph="&#xE72E;" 
                                              FontSize="12"
                                              Foreground="{ThemeResource SystemFillColorCautionBrush}"
                                              Visibility="{x:Bind IsModified, Mode=OneWay}"
                                              ToolTipService.ToolTip="Geändert"/>
                                    <FontIcon Glyph="&#xE72E;" 
                                              FontSize="12"
                                              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                              Visibility="{x:Bind IsProtected, Mode=OneWay}"
                                              ToolTipService.ToolTip="Geschützt"/>
                                </StackPanel>
                                <TextBlock Text="{x:Bind Description, Mode=OneWay}" 
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           TextWrapping="Wrap"
                                           MaxLines="2"/>
                            </StackPanel>

                            <!-- Unlock Time -->
                            <TextBlock Grid.Column="3" 
                                       VerticalAlignment="Center"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       Visibility="{x:Bind IsUnlocked, Mode=OneWay}">
                                <Run Text="Freigeschaltet:"/>
                                <Run Text="{x:Bind UnlockTime, Mode=OneWay}"/>
                            </TextBlock>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- Status Bar -->
        <Grid Grid.Row="5" 
              Padding="16,8"
              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock x:Name="StatusText"
                       VerticalAlignment="Center"
                       Style="{StaticResource CaptionTextBlockStyle}">
                <Run Text="{x:Bind ViewModel.FilteredTotalCount, Mode=OneWay}"/>
                <Run Text="Achievements angezeigt"/>
            </TextBlock>

                <StackPanel Grid.Column="1" 
                    Orientation="Horizontal"
                    Spacing="8"
                    VerticalAlignment="Center"
                    Visibility="{x:Bind ViewModel.IsPagingEnabled, Mode=OneWay}">
                <Button Content="&#xE72B;"
                    FontFamily="Segoe Fluent Icons"
                    Width="32" Height="28"
                    Command="{x:Bind ViewModel.PreviousPageCommand}"
                    IsEnabled="{x:Bind ViewModel.CanGoPrevious, Mode=OneWay}"/>
                <TextBlock Text="{x:Bind ViewModel.PageDisplay, Mode=OneWay}"
                       VerticalAlignment="Center"
                       Style="{StaticResource CaptionTextBlockStyle}"/>
                <Button Content="&#xE72A;"
                    FontFamily="Segoe Fluent Icons"
                    Width="32" Height="28"
                    Command="{x:Bind ViewModel.NextPageCommand}"
                    IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}"/>
                </StackPanel>

                <StackPanel Grid.Column="2" 
                        Orientation="Horizontal" 
                        Spacing="8"
                        Visibility="{x:Bind ViewModel.HasUnsavedChanges, Mode=OneWay}">
                <FontIcon Glyph="&#xE7BA;" FontSize="12" 
                          Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                <TextBlock Text="Ungespeicherte Änderungen" 
                           Style="{StaticResource CaptionTextBlockStyle}"
                           Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
            </StackPanel>
        </Grid>

        <!-- Loading Overlay -->
        <Grid x:Name="LoadingOverlay"
              Grid.RowSpan="6"
              Visibility="Collapsed"
              Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center"
                        Spacing="16">
                <ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock Text="Achievements werden geladen..." 
                           Style="{StaticResource BodyTextBlockStyle}"/>
            </StackPanel>
        </Grid>

        <!-- Error Info Bar -->
        <InfoBar x:Name="ErrorInfoBar"
                 Grid.Row="4"
                 VerticalAlignment="Top"
                 IsOpen="False"
                 Severity="Error"
                 Title="Fehler"/>
        
        <!-- Enhanced Notification Bar -->
        <controls:NotificationBar x:Name="NotificationBar"
                                  Grid.Row="4"
                                  VerticalAlignment="Top"
                                  Margin="0,8,0,0"/>
        
        <!-- Confetti Celebration Overlay -->
        <controls:ConfettiControl x:Name="ConfettiOverlay"
                                  Grid.RowSpan="6"/>
    </Grid>
</Page>
