<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SAM.WinUI.Views.GamePickerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SAM.WinUI.Views"
    xmlns:models="using:SAM.Core.Models"
    xmlns:controls="using:SAM.WinUI.Controls"
    NavigationCacheMode="Disabled">

    <Page.Resources>
        <!-- Default View Template (Medium Cards) -->
        <DataTemplate x:Key="DefaultViewTemplate" x:DataType="models:GameModel">
            <Grid Width="230" 
                  Height="120" 
                  CornerRadius="8"
                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                  BorderThickness="1"
                  Padding="0"
                  Tapped="GameItem_Tapped">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Game Logo/Image -->
                <Border Grid.RowSpan="2" CornerRadius="8">
                    <Grid>
                        <Grid x:Name="ImagePlaceholder"
                              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                            <FontIcon Glyph="&#xE7C3;"
                                      FontSize="28"
                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"/>
                        </Grid>
                        <Image x:Name="GameImage"
                               Stretch="UniformToFill"
                               HorizontalAlignment="Center"
                               Opacity="0"
                               ImageOpened="GameImage_ImageOpened"/>
                    </Grid>
                </Border>
                
                <!-- Gradient overlay -->
                <Border Grid.RowSpan="2" CornerRadius="8">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="Transparent" Offset="0.0"/>
                            <GradientStop Color="Transparent" Offset="0.4"/>
                            <GradientStop Color="#B0000000" Offset="1.0"/>
                        </LinearGradientBrush>
                    </Border.Background>
                </Border>

                <!-- DRM Protection Overlay -->
                <Border Grid.RowSpan="2"
                        CornerRadius="8"
                        Background="#80808080"
                        Visibility="{x:Bind HasDrmProtection, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- DRM Warning Icon -->
                <Border HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="8"
                        Padding="6"
                        CornerRadius="4"
                        Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
                        Visibility="{x:Bind HasDrmProtection, Converter={StaticResource BoolToVisibilityConverter}}"
                        ToolTipService.ToolTip="{x:Bind DrmProtectionInfo}">
                    <FontIcon Glyph="&#xE7BA;" FontSize="14"
                              Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                </Border>

                <!-- Game Info -->
                <Border Grid.Row="1"
                        CornerRadius="0,0,8,8"
                        Background="#E6000000">
                    <Grid Padding="12,8">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="{x:Bind Name}" 
                                   Style="{StaticResource BodyStrongTextBlockStyle}"
                                   Foreground="White"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="1"/>

                        <StackPanel Grid.Row="1" 
                                    Orientation="Horizontal" 
                                    Spacing="8"
                                    Margin="0,4,0,0">
                            <TextBlock Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="#B0FFFFFF">
                                <Run Text="{x:Bind AchievementCount}"/>
                                <Run Text="Achievements"/>
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </DataTemplate>

        <!-- Compact View Template (List with small icons) -->
        <DataTemplate x:Key="CompactViewTemplate" x:DataType="models:GameModel">
            <Grid Height="40" 
                  Padding="8,4"
                  CornerRadius="4"
                  Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                  Tapped="GameItem_Tapped">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="32"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Small Game Icon -->
                <Border CornerRadius="4" Width="32" Height="32">
                    <Grid>
                        <Grid x:Name="ImagePlaceholder"
                              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                            <FontIcon Glyph="&#xE7C3;"
                                      FontSize="14"
                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"/>
                        </Grid>
                        <Image x:Name="GameImage"
                               Width="32"
                               Height="32"
                               Stretch="UniformToFill"
                               Opacity="0"
                               ImageOpened="GameImage_ImageOpened"/>
                    </Grid>
                </Border>

                <!-- Game Name -->
                <TextBlock Grid.Column="1" 
                           Text="{x:Bind Name}" 
                           VerticalAlignment="Center"
                           Margin="12,0,0,0"
                           TextTrimming="CharacterEllipsis"
                           MaxLines="1"/>

                <!-- Achievement Count -->
                <TextBlock Grid.Column="2" 
                           VerticalAlignment="Center"
                           Margin="8,0"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           Style="{StaticResource CaptionTextBlockStyle}">
                    <Run Text="{x:Bind AchievementCount}"/>
                    <Run Text="ðŸ†"/>
                </TextBlock>

                <!-- DRM Warning -->
                <FontIcon Grid.Column="3"
                          Glyph="&#xE7BA;" 
                          FontSize="14"
                          Margin="4,0"
                          Foreground="{ThemeResource SystemFillColorCautionBrush}"
                          Visibility="{x:Bind HasDrmProtection, Converter={StaticResource BoolToVisibilityConverter}}"
                          ToolTipService.ToolTip="{x:Bind DrmProtectionInfo}"/>
            </Grid>
        </DataTemplate>

        <!-- Detail View Template (Large Cards with progress) -->
        <DataTemplate x:Key="DetailViewTemplate" x:DataType="models:GameModel">
            <Grid Width="320" 
                  Height="180" 
                  CornerRadius="8"
                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                  BorderThickness="1"
                  Padding="0"
                  Tapped="GameItem_Tapped">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Game Logo/Image -->
                <Border Grid.RowSpan="2" CornerRadius="8">
                    <Grid>
                        <Grid x:Name="ImagePlaceholder"
                              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                            <FontIcon Glyph="&#xE7C3;"
                                      FontSize="32"
                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"/>
                        </Grid>
                        <Image x:Name="GameImage"
                               Stretch="UniformToFill"
                               HorizontalAlignment="Center"
                               Opacity="0"
                               ImageOpened="GameImage_ImageOpened"/>
                    </Grid>
                </Border>
                
                <!-- Gradient overlay -->
                <Border Grid.RowSpan="2" CornerRadius="8">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="Transparent" Offset="0.0"/>
                            <GradientStop Color="Transparent" Offset="0.3"/>
                            <GradientStop Color="#D0000000" Offset="1.0"/>
                        </LinearGradientBrush>
                    </Border.Background>
                </Border>

                <!-- DRM Protection Overlay -->
                <Border Grid.RowSpan="2"
                        CornerRadius="8"
                        Background="#80808080"
                        Visibility="{x:Bind HasDrmProtection, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- DRM Warning Icon -->
                <Border HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="8"
                        Padding="6"
                        CornerRadius="4"
                        Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
                        Visibility="{x:Bind HasDrmProtection, Converter={StaticResource BoolToVisibilityConverter}}"
                        ToolTipService.ToolTip="{x:Bind DrmProtectionInfo}">
                    <FontIcon Glyph="&#xE7BA;" FontSize="14"
                              Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                </Border>

                <!-- Game Info with Progress -->
                <Border Grid.Row="1"
                        CornerRadius="0,0,8,8"
                        Background="#E6000000">
                    <Grid Padding="16,12">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="{x:Bind Name}" 
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Foreground="White"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="1"/>

                        <!-- Achievement Progress Bar -->
                        <Grid Grid.Row="1" Margin="0,8,0,4">
                            <ProgressBar Value="{x:Bind CompletionPercentage, Mode=OneTime}"
                                         Maximum="100"
                                         Height="6"
                                         CornerRadius="3"/>
                        </Grid>

                        <!-- Stats Row -->
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="#B0FFFFFF">
                                <Run Text="{x:Bind UnlockedAchievementCount}"/>
                                <Run Text="/"/>
                                <Run Text="{x:Bind AchievementCount}"/>
                                <Run Text="Achievements"/>
                            </TextBlock>

                            <TextBlock Grid.Column="1"
                                       Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="#80FFFFFF">
                                <Run Text="{x:Bind CompletionPercentage, Mode=OneTime}"/>
                                <Run Text="%"/>
                            </TextBlock>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>
        </DataTemplate>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Page Header -->
        <TextBlock x:Name="PageTitleText"
                   Text="Spiele" 
                   Style="{StaticResource TitleLargeTextBlockStyle}"
                   Margin="0,0,0,16"/>

        <StackPanel x:Name="RefreshIndicator"
                Grid.Row="0"
                Orientation="Horizontal"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Spacing="8"
                Margin="0,0,0,16"
                IsHitTestVisible="False"
                Visibility="{x:Bind ViewModel.IsBackgroundRefresh, Converter={StaticResource BoolToVisibilityConverter}}">
            <ProgressRing IsActive="True" Width="16" Height="16"/>
            <TextBlock x:Name="RefreshIndicatorText"
                   Text="Aktualisiere..."
                   Style="{StaticResource CaptionTextBlockStyle}"
                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
        </StackPanel>

        <!-- Search and Filter Bar -->
        <Grid Grid.Row="1" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MaxWidth="400"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <AutoSuggestBox x:Name="SearchBox"
                            PlaceholderText="Spiel suchen..."
                            QueryIcon="Find"
                            TextChanged="SearchBox_TextChanged"/>

            <ComboBox x:Name="FilterComboBox"
                      Grid.Column="1"
                      Margin="16,0,0,0"
                      Width="150"
                      SelectedIndex="0"
                      SelectionChanged="FilterComboBox_SelectionChanged">
                <ComboBoxItem x:Name="FilterAllItem" Content="Alle"/>
                <ComboBoxItem x:Name="FilterGamesItem" Content="Nur Spiele"/>
                <ComboBoxItem x:Name="FilterModsItem" Content="Nur Mods"/>
                <ComboBoxItem x:Name="FilterDlcsItem" Content="Nur DLCs"/>
                <ComboBoxItem x:Name="FilterDemosItem" Content="Nur Demos"/>
            </ComboBox>

            <!-- View Type Selector -->
            <StackPanel Grid.Column="2" 
                        Orientation="Horizontal" 
                        Margin="16,0,0,0"
                        Spacing="4">
                <RadioButton x:Name="ViewDefaultButton"
                             GroupName="ViewType"
                             Style="{StaticResource DefaultToggleButtonStyle}"
                             IsChecked="True"
                             Checked="ViewTypeButton_Checked"
                             ToolTipService.ToolTip="Standard-Ansicht">
                    <FontIcon Glyph="&#xF0E2;" FontSize="16"/>
                </RadioButton>
                <RadioButton x:Name="ViewCompactButton"
                             GroupName="ViewType"
                             Style="{StaticResource DefaultToggleButtonStyle}"
                             Checked="ViewTypeButton_Checked"
                             ToolTipService.ToolTip="Kompakte Liste">
                    <FontIcon Glyph="&#xE8FD;" FontSize="16"/>
                </RadioButton>
                <RadioButton x:Name="ViewDetailButton"
                             GroupName="ViewType"
                             Style="{StaticResource DefaultToggleButtonStyle}"
                             Checked="ViewTypeButton_Checked"
                             ToolTipService.ToolTip="Detail-Ansicht">
                    <FontIcon Glyph="&#xE8A9;" FontSize="16"/>
                </RadioButton>
            </StackPanel>

            <Button Grid.Column="3"
                    Margin="16,0,0,0"
                    Click="RefreshButton_Click">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                    <TextBlock x:Name="RefreshButtonText" Text="Aktualisieren"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Games Grid -->
        <ScrollViewer x:Name="GamesRepeaterScroll"
                      Grid.Row="2"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsRepeater x:Name="GamesRepeater"
                            ItemsSource="{x:Bind ViewModel.FilteredGames, Mode=OneWay}"
                            ItemTemplate="{StaticResource DefaultViewTemplate}"
                            ElementPrepared="GamesRepeater_ElementPrepared"
                            ElementClearing="GamesRepeater_ElementClearing">
                <ItemsRepeater.Layout>
                    <UniformGridLayout x:Name="GamesRepeaterLayout"
                                       MinItemWidth="230"
                                       MinItemHeight="120"
                                       MinColumnSpacing="12"
                                       MinRowSpacing="12"/>
                </ItemsRepeater.Layout>
            </ItemsRepeater>
        </ScrollViewer>

        <!-- Games List (for Compact View) -->
        <ScrollViewer x:Name="GamesListRepeaterScroll"
                      Grid.Row="2"
                      HorizontalScrollBarVisibility="Disabled"
                      Visibility="Collapsed">
            <ItemsRepeater x:Name="GamesListRepeater"
                            ItemsSource="{x:Bind ViewModel.FilteredGames, Mode=OneWay}"
                            ItemTemplate="{StaticResource CompactViewTemplate}"
                            ElementPrepared="GamesRepeater_ElementPrepared"
                            ElementClearing="GamesRepeater_ElementClearing">
                <ItemsRepeater.Layout>
                    <StackLayout Spacing="6"/>
                </ItemsRepeater.Layout>
            </ItemsRepeater>
        </ScrollViewer>

        <!-- Loading Overlay -->
        <Grid x:Name="LoadingOverlay"
              Grid.RowSpan="3"
              Visibility="Collapsed"
              Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center"
                        Spacing="16">
                <ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock x:Name="LoadingText"
                           Text="Spiele werden geladen..." 
                           Style="{StaticResource BodyTextBlockStyle}"/>
            </StackPanel>
        </Grid>

        <!-- Error Info Bar -->
        <InfoBar x:Name="ErrorInfoBar"
                 Grid.Row="2"
                 VerticalAlignment="Bottom"
                 IsOpen="False"
                 Severity="Error"
                 Title="Fehler"/>

        <!-- Empty State -->
        <StackPanel x:Name="EmptyState"
                    Grid.Row="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="Collapsed">
            <FontIcon Glyph="&#xE8F1;" FontSize="64" 
                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            <TextBlock x:Name="EmptyTitleText"
                       Text="Keine Spiele gefunden" 
                       Style="{StaticResource SubtitleTextBlockStyle}"
                       Margin="0,16,0,8"/>
            <TextBlock x:Name="EmptyDescriptionText"
                       Text="Stelle sicher, dass Steam lÃ¤uft und du eingeloggt bist."
                       Style="{StaticResource BodyTextBlockStyle}"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
        </StackPanel>
    </Grid>
</Page>
